# 分片加载功能测试指南

## 功能说明

现在的广告报表支持智能分片加载，大幅提升性能。

### 核心特性

1. **默认只加载最后1个月** - 初始加载仅1.6万条记录（1.9MB）
2. **按需加载** - 选择日期范围时自动加载对应月份
3. **智能缓存** - 已加载的月份不会重复加载
4. **一键全量** - 支持点击按钮加载所有62万条数据

## 测试步骤

### 1. 初始加载测试

**预期行为**:
- 页面加载时只请求最后1个月（2025-11）
- 显示约15,822条记录
- 加载速度非常快（<100ms）

**验证方法**:
```
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 刷新页面
4. 查看 API 请求：
   - 请求 URL: /api/ad-report/shards?months=2025-11
   - 响应大小: ~1.9MB
   - 响应时间: 应该很快
```

**控制台日志**:
```
Loading initial months: ["2025-11"]
Loaded ad report data: { months: ["2025-11"], rows: 15822 }
```

### 2. 日期范围选择测试

**测试场景 A: 选择近3个月**

```
操作:
1. 点击日期选择器
2. 选择开始日期: 2025-09-01
3. 选择结束日期: 2025-11-30
4. 观察页面变化
```

**预期行为**:
- 自动加载 2025-09 和 2025-10 两个月的数据
- 显示提示框："选择日期范围: 2025-09-01 至 2025-11-30"
- 记录数增加到约 230,307 条
- 已加载月份更新为: "2025-09, 2025-10, 2025-11"

**控制台日志**:
```
Date range selected: {
  start: "2025-09-01",
  end: "2025-11-30",
  monthsInRange: ["2025-09", "2025-10", "2025-11"]
}
Loading additional months for date range: ["2025-09", "2025-10"]
Loaded additional data: { months: ["2025-09", "2025-10"], rows: 214485 }
```

**Network请求**:
```
- 请求 URL: /api/ad-report/shards?months=2025-09,2025-10
- 响应大小: ~24.8MB
- 响应头 X-Loaded-Months: 2025-09,2025-10
- 响应头 X-Row-Count: 214485
```

**测试场景 B: 选择历史数据**

```
操作:
1. 清除之前的日期选择（点击Alert的X）
2. 重新选择: 2025-01-01 至 2025-03-31
3. 观察加载行为
```

**预期行为**:
- 加载 2025-01, 2025-02, 2025-03 三个月
- 不会重新加载已有的月份
- 数据累加到现有数据中

### 3. 日期限制测试

**测试**:
```
1. 打开日期选择器
2. 尝试选择 2024-10-01（早于最早数据）
3. 尝试选择 2025-12-01（晚于最晚数据）
```

**预期行为**:
- 2024-11 之前的日期显示为灰色不可选
- 2025-11 之后的日期显示为灰色不可选
- 只能选择有数据的日期范围（2024-11-01 至 2025-11-30）

### 4. 加载全部数据测试

**操作**:
```
1. 刷新页面（重置到初始状态）
2. 点击"加载全部数据"按钮
3. 等待加载完成
```

**预期行为**:
- 显示 Loading 状态
- 一次性加载所有剩余月份（12个月）
- 总记录数达到 621,971 条
- 按钮变为灰色disabled状态
- 已加载月份显示所有13个月

**控制台日志**:
```
Loading all months: ["2024-11", "2024-12", "2025-01", ..., "2025-10"]
Loaded all data: { months: [...], rows: 606149 }
```

**Network请求**:
```
- 请求 URL: /api/ad-report/shards?months=2024-11,2024-12,...
- 响应大小: ~70MB
- 加载时间: 可能需要1-3秒
```

### 5. 性能对比测试

**场景 A: 分片加载（默认）**
```
1. 刷新页面
2. 记录初始加载时间
3. 观察页面响应速度
```
预期: 加载<100ms，页面立即可交互

**场景 B: 全量加载**
```
1. 点击"加载全部数据"
2. 记录加载时间
3. 观察页面响应速度
```
预期: 加载1-3秒，数据处理需要额外时间

**对比结果**:
- 初始加载速度: 分片快 **~20-40倍**
- 内存占用: 分片少 **~96%**
- 网络传输: 分片少 **~97%**

### 6. 数据准确性测试

**验证方法**:
```
1. 选择日期范围: 2025-09-01 至 2025-09-30
2. 检查图表和表格显示的数据
3. 确认只显示9月份的数据
4. 检查总览指标是否正确
```

**预期**:
- 图表X轴只显示9月的日期
- 总曝光量/点击量等指标符合9月数据
- 明细表格中所有日期都在9月范围内

## 常见问题

### Q1: 选择日期后没有数据显示？
**A**: 检查是否选择的日期在可用范围外。可用范围：2024-11-01 至 2025-11-30

### Q2: 多次选择日期会重复加载吗？
**A**: 不会。已加载的月份会被缓存，不会重复请求。

### Q3: 如何清除已选择的日期范围？
**A**: 点击蓝色提示框右上角的 X 关闭按钮。

### Q4: 加载全部数据后，按钮为什么变灰了？
**A**: 所有月份都已加载，无需再次加载。刷新页面可重置。

## 性能指标

| 操作 | 数据量 | 文件大小 | 预期时间 |
|------|--------|---------|---------|
| 初始加载 | 15,822条 | 1.9 MB | <100ms |
| 加载近3月 | 230,307条 | 26.7 MB | 200-500ms |
| 加载全年 | 621,971条 | 72 MB | 1-3s |

## 调试技巧

### 查看已加载月份
查看页面标题栏右侧：
```
已加载: 2025-11 | 共 15,822 条记录 / 总计 621,971 条 (13 个月份可用)
```

### 查看Network请求
```
1. F12 打开开发者工具
2. Network 标签
3. 筛选 XHR 请求
4. 查看 /api/ad-report/shards 请求
5. 检查响应头中的 X-Loaded-Months 和 X-Row-Count
```

### 查看控制台日志
所有数据加载操作都会在控制台输出详细日志，包括：
- 加载的月份列表
- 记录数量
- 数据样本

## 成功标准

✅ 初始加载时间 < 100ms
✅ 日期选择后能自动加载对应月份
✅ 不会重复加载已有数据
✅ 数据显示准确无误
✅ 全量加载功能正常
✅ 性能提升明显（vs 全量加载）
