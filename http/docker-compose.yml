services:
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    # 生产环境使用 Granian（4 workers，极致性能）
    command: granian arrow_service.main:app --interface asgi --host 0.0.0.0 --port 8000 --workers 4 --http 1 --backlog 2048 --loop uvloop --respawn-failed-workers
    volumes:
      - ../data:/app/data:ro
    environment:
      PYTHONUNBUFFERED: "1"
    networks:
      - default  # 只使用内部网络
    restart: unless-stopped

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    environment:
      - BACKEND_HOST=backend
      # Nginx 性能优化：设置 worker 进程数（生产环境默认 3）
      - NGINX_WORKER_PROCESSES=${NGINX_WORKER_PROCESSES:-3}
    volumes:
      # nginx 配置挂载到 default.conf.template（覆盖 nginx 默认配置）
      - ../frontend/nginx.conf.template:/etc/nginx/templates/default.conf.template:ro
    depends_on:
      backend:
        condition: service_started
    networks:
      default:
        # 内部网络使用简单服务名
      gateway-http:
        aliases:
          - ${COMPOSE_PROJECT_NAME}-frontend  # 外部网络使用唯一别名
    labels:
      - traefik.enable=true
      - traefik.http.routers.arrow.rule=Host(`arrow.${DOMAIN}`)
      - traefik.http.routers.arrow.entrypoints=web
      - traefik.http.routers.arrow.middlewares=strip-user-headers@file,oidc-auth@file
      - traefik.http.services.arrow.loadbalancer.server.port=80
    restart: unless-stopped

networks:
  default:
    name: ${COMPOSE_PROJECT_NAME:-arrow-http}_internal
  gateway-http:
    external: true
