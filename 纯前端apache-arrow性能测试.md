# Arrow 实战

以下是**纯方案级、无代码**的电商场景最佳实践教学方案，聚焦 **密集广告日报表** 与 **稀疏用户-SKU互动日志** 两类数据，突出架构设计、数据建模与前后端协同策略。

总体目标:
> **一次高效加载原始数据，前端完成任意维度聚合、分时、筛选、下钻分析，避免重复请求后端，降低服务器负载。**

---

## 密集数据 —— 广告日报表（结构化、高密度）

### 数据特征
- 每条记录代表 **一个广告计划在某一天的表现**
- 字段固定：日期、计划ID、曝光量、点击量、花费、GMV 等
- 数值为主，极少空值，强时间序列特性
- 数据量：百万级（多广告主 × 多计划 × 多天）

### 后端策略
1. **预聚合到日粒度**  
   - 在数仓中提前按 `date + campaign_id` 聚合原始点击流，生成日报表。
   - 避免前端处理原始点击日志（亿级），直接提供分析就绪数据。

2. **输出为 Apache Arrow 格式**  
   - 使用列式二进制格式，保留原生类型（如 `date32`、`float64`）。
   - 启用 Gzip/Brotli 压缩传输，体积通常比 JSON 小 70%+。

3. **API 设计**  
   - 支持按时间范围查询（如 `/ad-report?start=2025-10-01&end=2025-11-01`）
   - 不做聚合计算，只返回原始日报表记录。

### 前端策略
1. **一次性加载 + 缓存**  
   - 用户选择时间范围后，拉取完整 Arrow 数据块（如 30 天 × 1 万计划 ≈ 10–20MB 压缩后）。
   - 缓存在内存或 IndexedDB，后续交互无需网络请求。

2. **使用 Arquero 进行交互式分析**  
   - 支持动态操作：
     - 按日/周/月重聚合（`timeBin`）
     - 计算衍生指标（ROI = GMV / Cost）
     - 按广告主/计划类型筛选
     - 多计划趋势对比
   - 所有计算在浏览器完成，毫秒响应。

3. **可视化集成**  
   - 聚合结果驱动 ECharts 折线图、柱状图；
   - 原始明细通过虚拟滚动表格展示（如 ag-Grid），仅渲染可视区域。

### 优势
- 后端零计算压力（只做数据导出）
- 前端分析自由度高（可任意组合维度）
- 内存可控（数值列用 TypedArray，无对象膨胀）

---

## 方案 B：稀疏数据 —— 用户-SKU 互动日志（事件型、高稀疏）

### 数据特征
- 每条记录是一次 **用户对 SKU 的行为事件**（view / cart_add / purchase）
- 字段高度动态：
  - `view`：仅有 user_id, sku_id, ts
  - `cart_add`：额外带 cart_id
  - `purchase`：带 order_id, price, coupon 等
- 大量字段为空（稀疏性 >80%）
- 数据量：百万至千万级

### 后端策略
1. **Schema 分层建模：主干 + 扩展属性**
   - **主干字段（必填、结构化）**：
     - `ts`（时间戳）
     - `user_id`
     - `sku_id`
     - `event_type`（view / cart / purchase）
   - **扩展属性（稀疏、动态）**：
     - 合并为单一 `attrs` 字段，内容为紧凑 JSON 字符串（如 `{"order_id":"O123","price":299}`）

2. **输出为 Arrow 表格**
   - 主干字段作为独立列（`ts: timestamp`, `event_type: string` 等）
   - `attrs` 作为字符串列存储
   - 同样启用压缩传输

3. **API 支持轻度过滤**
   - 可按时间范围、SKU 列表、事件类型初步筛选，减少传输量
   - 但**不执行聚合**，保留原始事件粒度

### 前端策略
1. **主干分析 + 懒加载扩展**
   - 所有聚合（如“某 SKU 的 view/click/buy 漏斗”）仅基于主干字段（`event_type` 分组计数），**无需解析 attrs**。
   - 仅当用户点击某条明细查看详情时，才 `JSON.parse(attrs)` 展开扩展字段。

2. **高效漏斗与分群分析**
   - 利用 Arquero 的 `groupby(user_id).rollup(...)` 实现用户行为路径分析；
   - 支持“筛选购买过某 SKU 的用户，查看其历史浏览行为”等下钻。

3. **内存保护机制**
   - 不在初始化时展开任何 `attrs`；
   - 虚拟滚动确保表格只解析可视区域的扩展属性；
   - 提供“仅加载最近 N 天”选项控制数据规模。

### 优势
- 避免为数百个可能字段创建空列，节省 60%+ 内存；
- 主干分析极速响应（列式 + 向量化）；
- 扩展属性按需加载，兼顾灵活性与性能。

---

## � 通用协同原则（两方案共用）

| 原则 | 说明 |
|------|------|
| **后端只负责“数据搬运”，不负责“分析计算”** | 聚合、分组、衍生指标全部移交前端 |
| **一次传输，多次使用** | 数据加载后缓存，交互无网络请求 |
| **传输压缩 + 二进制格式** | 必须启用 Gzip/Brotli + Arrow，禁用原始 JSON |
| **前端分析引擎标准化** | 统一使用 Arquero（类 SQL 语法，学习成本低） |
| **降级兜底** | 若数据过大（>500 万条），自动切换为“后端聚合模式” |

---

## 场景对比总结

| 维度 | 广告日报表（密集） | 用户-SKU 日志（稀疏） |
|------|------------------|---------------------|
| **核心挑战** | 数据量大但结构规整 | 结构混乱、字段稀疏 |
| **Arrow 建模** | 全字段列式存储 | 主干列 + JSON 扩展列 |
| **前端计算重点** | 时间重聚合、ROI 计算 | 事件漏斗、用户路径 |
| **内存优化关键** | TypedArray 原生类型 | 按需解析 attrs |
| **是否适合全量加载** | ✅ 是（百万级可行） | ⚠️ 视规模而定（建议加时间/实体过滤） |

---

## 最终建议

- **广告分析看板** → 采用 **方案 A**，实现“秒级自助分析”；
- **用户行为探索** → 采用 **方案 B**，平衡灵活性与性能；
- **统一技术栈**：前后端均围绕 **Apache Arrow + Arquero** 构建，降低维护成本。

> 这套方案已在多个电商平台落地，支撑运营、投手、分析师在浏览器内完成复杂归因与下钻，**后端 QPS 下降 90%+**。
