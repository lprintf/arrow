services:
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    volumes:
      - ../data:/app/data:ro
    environment:
      PYTHONUNBUFFERED: "1"
    networks:
      - default  # 内部网络
    restart: unless-stopped

  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
    environment:
      - BACKEND_HOST=backend
    depends_on:
      backend:
        condition: service_started
    networks:
      default:
        # 内部网络使用简单服务名
      gateway-http:
        aliases:
          - ${COMPOSE_PROJECT_NAME}-frontend  # 外部网络使用唯一别名
    labels:
      - traefik.enable=true
      - traefik.http.routers.arrow.rule=Host(`arrow.${DOMAIN}`)
      - traefik.http.routers.arrow.entrypoints=websecure
      - traefik.http.routers.arrow.tls=true
      - traefik.http.routers.arrow.middlewares=strip-user-headers@file,oidc-auth@file
      - traefik.http.services.arrow.loadbalancer.server.port=80
    restart: unless-stopped

networks:
  default:
    name: ${COMPOSE_PROJECT_NAME:-arrow-https}_internal
  gateway-https:
    external: true
